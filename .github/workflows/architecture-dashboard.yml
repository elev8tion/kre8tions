name: Architecture Progress Dashboard

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM
  workflow_dispatch:  # Allow manual trigger

jobs:
  generate-dashboard:
    name: Generate Architecture Progress Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Collect metrics
        id: metrics
        run: |
          echo "Collecting codebase metrics..."

          # Deprecated API count
          DEPRECATED_COUNT=$(grep -r "\.withOpacity(" lib/ assets/ide_source/ --include="*.dart" | wc -l || echo "0")
          echo "deprecated_apis=$DEPRECATED_COUNT" >> $GITHUB_OUTPUT

          # Large files count
          LARGE_FILES=$(find lib/ -name "*.dart" -exec wc -l {} + | awk '$1 > 1000' | wc -l || echo "0")
          echo "large_files=$LARGE_FILES" >> $GITHUB_OUTPUT

          # TODO count
          TODO_COUNT=$(grep -r "TODO\|FIXME" lib/ --include="*.dart" | wc -l || echo "0")
          echo "todo_count=$TODO_COUNT" >> $GITHUB_OUTPUT

          # Test file count
          TEST_FILES=$(find test/ -name "*_test.dart" | wc -l || echo "0")
          echo "test_files=$TEST_FILES" >> $GITHUB_OUTPUT

          # Check for DI
          if grep -q "get_it:\|provider:" pubspec.yaml; then
            echo "has_di=true" >> $GITHUB_OUTPUT
          else
            echo "has_di=false" >> $GITHUB_OUTPUT
          fi

          # Service count
          SERVICE_FILES=$(find lib/services/ -name "*.dart" | wc -l || echo "0")
          echo "service_files=$SERVICE_FILES" >> $GITHUB_OUTPUT

          # Total lines of code
          TOTAL_LINES=$(find lib/ -name "*.dart" -exec wc -l {} + | tail -1 | awk '{print $1}' || echo "0")
          echo "total_lines=$TOTAL_LINES" >> $GITHUB_OUTPUT

      - name: Create progress dashboard issue
        uses: actions/github-script@v7
        with:
          script: |
            const deprecatedApis = '${{ steps.metrics.outputs.deprecated_apis }}';
            const largeFiles = '${{ steps.metrics.outputs.large_files }}';
            const todoCount = '${{ steps.metrics.outputs.todo_count }}';
            const testFiles = '${{ steps.metrics.outputs.test_files }}';
            const hasDI = '${{ steps.metrics.outputs.has_di }}';
            const serviceFiles = '${{ steps.metrics.outputs.service_files }}';
            const totalLines = '${{ steps.metrics.outputs.total_lines }}';

            const today = new Date().toISOString().split('T')[0];

            // Calculate progress percentages
            const immediateProgress = deprecatedApis === '0' ? 100 : Math.max(0, 100 - (deprecatedApis / 38 * 100));
            const shortTermProgress = hasDI === 'true' && largeFiles === '0' ? 100 : 50;
            const longTermProgress = 20; // Placeholder, adjust based on actual progress

            const title = `üìä Architecture Progress Dashboard - ${today}`;
            const body = `# üèóÔ∏è KRE8TIONS Architecture Progress Dashboard

            **Report Date**: ${today}
            **Codebase Size**: ${totalLines} lines across ${serviceFiles} services

            ---

            ## üìà Overall Progress

            | Phase | Progress | Status |
            |-------|----------|--------|
            | **Immediate (This Week)** | ${immediateProgress.toFixed(0)}% | ${immediateProgress === 100 ? '‚úÖ Complete' : 'üöß In Progress'} |
            | **Short-term (2-4 Weeks)** | ${shortTermProgress.toFixed(0)}% | üöß In Progress |
            | **Long-term (2-3 Months)** | ${longTermProgress.toFixed(0)}% | üìã Planned |

            ---

            ## ‚ö° IMMEDIATE TASKS (This Week)

            ### 1. Fix Deprecated APIs
            - **Status**: ${deprecatedApis === '0' ? '‚úÖ Complete' : '‚ùå Needs Action'}
            - **Current**: ${deprecatedApis} instances of \`withOpacity()\`
            - **Target**: 0
            - **Priority**: üî¥ HIGH (blocks Flutter upgrades)
            - **Time**: 30 minutes

            ${deprecatedApis !== '0' ? `
            **Action Required**:
            \`\`\`bash
            # Find all instances
            grep -r "\\.withOpacity(" lib/ assets/ide_source/

            # Replace with .withValues(alpha: X)
            \`\`\`
            ` : ''}

            ### 2. Add Service Failure Tests
            - **Status**: üöß In Progress
            - **Current**: ${testFiles} test files
            - **Priority**: üî¥ HIGH (critical for stability)
            - **Time**: 2-3 hours

            **Tests Needed**:
            - [ ] Service failure scenarios
            - [ ] Error recovery tests
            - [ ] Persistence layer fallbacks

            ### 3. Document Public API Contracts
            - **Status**: üìã Pending
            - **Priority**: üü° MEDIUM (improves maintainability)
            - **Time**: 1 hour

            **Documentation Needed**:
            - [ ] Class-level docs for public classes
            - [ ] Method documentation
            - [ ] Create ARCHITECTURE.md
            - [ ] Create API.md

            ---

            ## üéØ SHORT-TERM TASKS (2-4 Weeks)

            ### 1. Refactor Monolithic Services
            - **Status**: ${largeFiles === '0' ? '‚úÖ Complete' : '‚ùå Needs Action'}
            - **Current**: ${largeFiles} files >1,000 lines
            - **Priority**: üü° MEDIUM
            - **Time**: 2-4 weeks

            **Files to Refactor**:
            - \`project_template_service.dart\` (3,212 lines)
            - \`ai_code_generation_service.dart\` (1,445 lines)
            - \`advanced_features_service.dart\` (936 lines)

            ### 2. Implement Dependency Injection
            - **Status**: ${hasDI === 'true' ? '‚úÖ Complete' : '‚ùå Not Started'}
            - **Priority**: üü° MEDIUM
            - **Time**: 1-2 weeks

            ${hasDI !== 'true' ? `
            **Recommended**: Add \`get_it\` or \`provider\` package
            \`\`\`yaml
            dependencies:
              get_it: ^7.6.0
            \`\`\`
            ` : ''}

            ### 3. Complete AI Integration
            - **Status**: üìã Pending
            - **Priority**: üü° MEDIUM
            - **Time**: 2-3 weeks

            **Tasks**:
            - [ ] Complete OpenAI API integration
            - [ ] Remove scaffolding or implement features
            - [ ] Add usage cost tracking

            ### 4. Add Performance Benchmarks
            - **Status**: üìã Pending
            - **Priority**: üü° MEDIUM
            - **Time**: 1 week

            **Benchmarks Needed**:
            - [ ] Code analysis on large files (10k+ lines)
            - [ ] UI with 500+ widgets
            - [ ] Memory profiling

            ---

            ## üöÄ LONG-TERM TASKS (2-3 Months)

            ### 1. Extract Browser API Abstraction
            - **Status**: üìã Planned
            - **Priority**: üü¢ LOW
            - **Time**: 2-3 weeks

            **Goal**: Create testable wrappers for \`dart:html\`

            ### 2. Implement Real-time Collaboration
            - **Status**: üìã Planned (WebSocket infrastructure exists)
            - **Priority**: üü¢ LOW
            - **Time**: 4-6 weeks

            **Tasks**:
            - [ ] Complete WebSocket logic
            - [ ] Operational transformation
            - [ ] Conflict resolution

            ### 3. Build Automated Refactoring
            - **Status**: üìã Planned
            - **Priority**: üü¢ LOW
            - **Time**: 3-4 weeks

            **Refactorings to Implement**:
            - [ ] Extract method
            - [ ] Rename symbol
            - [ ] Extract widget
            - [ ] Convert widget types

            ---

            ## üìä Quality Metrics

            | Metric | Current | Target | Status |
            |--------|---------|--------|--------|
            | Deprecated APIs | ${deprecatedApis} | 0 | ${deprecatedApis === '0' ? '‚úÖ' : '‚ùå'} |
            | Large Files (>1k lines) | ${largeFiles} | 0 | ${largeFiles === '0' ? '‚úÖ' : '‚ùå'} |
            | TODO Comments | ${todoCount} | <50 | ${parseInt(todoCount) < 50 ? '‚úÖ' : '‚ö†Ô∏è'} |
            | Test Files | ${testFiles} | 25+ | ${parseInt(testFiles) >= 25 ? '‚úÖ' : '‚ö†Ô∏è'} |
            | Dependency Injection | ${hasDI === 'true' ? 'Yes' : 'No'} | Yes | ${hasDI === 'true' ? '‚úÖ' : '‚ùå'} |

            ---

            ## üéØ This Week's Focus

            1. **Fix all ${deprecatedApis} deprecated API calls** (30 min)
            2. **Add service failure tests** (2-3 hours)
            3. **Document 10 most important public APIs** (1 hour)

            **Total Time**: ~4 hours for immediate improvements

            ---

            ## üìã Action Items

            **For Developers**:
            - [ ] Review and address deprecated APIs
            - [ ] Add missing tests
            - [ ] Update documentation

            **For Reviewers**:
            - [ ] Check PR impact on architecture goals
            - [ ] Verify test coverage
            - [ ] Ensure documentation updates

            ---

            ## üìÖ Next Review

            **Date**: ${new Date(Date.now() + 7*24*60*60*1000).toISOString().split('T')[0]}

            This dashboard is auto-generated weekly. Track progress via linked issues.

            ---

            **Related Issues**: #architecture #tech-debt #roadmap
            `;

            // Check if a dashboard issue exists from this week
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dashboard'
            });

            const thisWeekIssue = issues.data.find(issue =>
              issue.title.includes(today)
            );

            if (thisWeekIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: thisWeekIssue.number,
                body: body
              });
            } else {
              // Close last week's dashboard
              const lastWeekDashboard = issues.data.find(issue =>
                issue.title.includes('Architecture Progress Dashboard')
              );

              if (lastWeekDashboard) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: lastWeekDashboard.number,
                  state: 'closed',
                  state_reason: 'completed'
                });
              }

              // Create new dashboard issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['dashboard', 'architecture', 'tracking']
              });
            }
